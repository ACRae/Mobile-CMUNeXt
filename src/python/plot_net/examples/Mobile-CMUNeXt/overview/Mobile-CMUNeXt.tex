\documentclass[border=8pt, multi, tikz]{standalone}
%\usepackage{blocks}
\usepackage{import}
\subimport{../../../layers}{init}

\def\ConvColor{rgb:yellow,5;red,2.5;white,5}
\def\ConvReluColor{rgb:yellow,5;red,5;white,5}
\def\BatchNormColor{rgb:yellow,4;red,4;white,4}
\def\MaxpoolColor{rgb:red,7;black,5}
\def\FusionColor{rgb:blue,5;red,4;white,5}
\def\CmunextBlockColor{rgb:blue,5;white,3}
\def\UpsampleColor{rgb:blue,5;green,12;black,8}

\def\ClassifierColor{rgb:magenta,5;black,10}
\def\SkipConnectionColor{rgb:blue,4;red,1;green,1;black,3}


\newcommand{\copymidarrow}{\tikz \draw[-Stealth,line width =0.8mm,draw={\SkipConnectionColor}] (-0.3,0) -- ++(0.3,0);}

\begin{document}
\begin{tikzpicture}
\tikzstyle{connection}=[ultra thick,every node/.style={sloped,allow upside down},draw=\edgecolor,opacity=0.7]
\tikzstyle{copyconnection}=[ultra thick,every node/.style={sloped,allow upside down},draw={\SkipConnectionColor},opacity=0.7]

%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
%% Draw Encoder
%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
% input image
% \node[canvas is zy plane at x=0] (temp) at (-3,0,0) {\includegraphics[width=8cm,height=8cm]{../6_A.png}};


% stem
\pic[shift={(0,0,0)}] at (0,0,0) {DoubleRightBandedBox={%
        name=stem,%
        xlabel={{"C1", ""}},%
        zlabel=I,%
        zlabelmiddle=false,
        sticky=false,
        fill=\ConvColor,%
        bandonefill=\ConvReluColor,%
        bandtwofill=\BatchNormColor,%
        height=40,%
        width={3},%
        depth=40,%
        caption=Stem
}};

%%%%%%%%%%%%%%%%%%%5
\pic[shift={(1.5,0,0)}] at (stem-east) {Box={
        name=cmunext-block1,%
        fill=\CmunextBlockColor,
        opacity=0.6,
        height=40,
        width=3,
        depth=40,
        xlabel={{"C1", ""}}
}};

\pic[shift={(0,0,0)}] at (cmunext-block1-east) {DoubleRightBandedBox={%
        name=conv1,%
        xlabel={{"C1", ""}},%
        zlabel={I},%
        zlabelmiddle=false,
        sticky=false,
        fill=\ConvColor,%
        bandonefill=\ConvReluColor,%
        bandtwofill=\BatchNormColor,%
        height=40,%
        width={3},%
        depth=40%
}};



%maxpool1
\pic[shift={(0,0,0)}] at (conv1-east) {Box={
        name=maxpool1,%
        fill=\MaxpoolColor,
        opacity=0.5,
        height=32,
        width=1,
        depth=32
}};


%%%%%%%%%%%%%%%%%%%%

\pic[shift={(1,0,0)}] at (maxpool1-east) {Box={
        name=cmunext-block2,%
        fill=\CmunextBlockColor,
        opacity=0.6,
        height=32,
        width=4,
        depth=32,
        xlabel={{"C2", ""}}
}};

\pic[shift={(0,0,0)}] at (cmunext-block2-east) {DoubleRightBandedBox={%
        name=conv2,%
        xlabel={{"C2", ""}},%
        zlabel={I/2},%
        zlabelmiddle=false,
        sticky=false,
        fill=\ConvColor,%
        bandonefill=\ConvReluColor,%
        bandtwofill=\BatchNormColor,%
        height=32,%
        width={4},%
        depth=32%
}};



%maxpool2
\pic[shift={(0,0,0)}] at (conv2-east) {Box={
        name=maxpool2,%
        fill=\MaxpoolColor,
        opacity=0.5,
        height=25,
        width=1,
        depth=25
}};

%%%%%%%%%%%%%%%%%%%%

\pic[shift={(1,0,0)}] at (maxpool2-east) {Box={
        name=cmunext-block3,%
        fill=\CmunextBlockColor,
        opacity=0.6,
        height=25,
        width=5,
        depth=25,
        xlabel={{"C3", ""}}
}};

\pic[shift={(0,0,0)}] at (cmunext-block3-east) {DoubleRightBandedBox={%
        name=conv3,%
        xlabel={{"C3", ""}},%
        zlabel={I/4},%
        zlabelmiddle=false,
        sticky=false,
        fill=\ConvColor,%
        bandonefill=\ConvReluColor,%
        bandtwofill=\BatchNormColor,%
        height=25,%
        width={5},%
        depth=25%
}};



%maxpool3
\pic[shift={(0,0,0)}] at (conv3-east) {Box={
        name=maxpool3,%
        fill=\MaxpoolColor,
        opacity=0.5,
        height=16,
        width=1,
        depth=16
}};

%%%%%%%%%%%%%%%%%%%%

\pic[shift={(1,0,0)}] at (maxpool3-east) {Box={
        name=cmunext-block4,%
        fill=\CmunextBlockColor,
        opacity=0.6,
        height=16,
        width=6,
        depth=16,
        xlabel={{"C4", ""}}
}};

\pic[shift={(0,0,0)}] at (cmunext-block4-east) {DoubleRightBandedBox={%
        name=conv4,%
        xlabel={{"C4", ""}},%
        zlabel={I/8},%
        zlabelmiddle=false,
        sticky=false,
        fill=\ConvColor,%
        bandonefill=\ConvReluColor,%
        bandtwofill=\BatchNormColor,%
        height=16,%
        width={6},%
        depth=16%
}};



%maxpool4
\pic[shift={(0,0,0)}] at (conv4-east) {Box={
        name=maxpool4,%
        fill=\MaxpoolColor,
        opacity=0.5,
        height=8,
        width=1,
        depth=8
}};
%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
%% Bottleneck
%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%% 

\pic[shift={(1,0,0)}] at (maxpool4-east) {Box={
        name=cmunext-block5,%
        fill=\CmunextBlockColor,
        opacity=0.6,
        height=8,
        width=8,
        depth=8,
        xlabel={{"C5", ""}},
}};

\pic[shift={(0,0,0)}] at (cmunext-block5-east) {DoubleRightBandedBox={%
        name=conv5,%
        xlabel={{"C5", ""}},%
        zlabelmiddle=false,
        zlabel={I/16},%
        sticky=false,
        fill=\ConvColor,%
        bandonefill=\ConvReluColor,%
        bandtwofill=\BatchNormColor,%
        height=8,%
        width={8},%
        depth=8,%
}};
%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
%% Draw Decoder 
%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
\pic[shift={(1.5,0,0)}] at (conv5-east) {Box={
        name=upsample4,%
        fill=\UpsampleColor,
        opacity=0.6,
        height=16,%
        width=1,%
        depth=16,%
}};

\pic[shift={(0,0,0)}] at (upsample4-east) {DoubleRightBandedBox={%
        name=upconv4,%
        xlabel={{"C4", ""}},%
        zlabelmiddle=false,
        sticky=false,
        fill=\ConvColor,%
        bandonefill=\ConvReluColor,%
        bandtwofill=\BatchNormColor,%
        height=16,%
        width={6},%
        depth=16%
}};

\pic[shift={(0,0,0)}] at (upconv4-east) {Box={
        name=fusion4,%
        fill=\FusionColor,
        opacity=0.6,
        height=16,%
        width=6,%
        depth=16,%
        xlabel={{"C4", ""}},
        zlabel={I/8},%
        zlabelmiddle=false
}};

%%%%%%%%%%%%%%


\pic[shift={(1.5,0,0)}] at (fusion4-east) {Box={
        name=upsample3,%
        fill=\UpsampleColor,
        opacity=0.6,
        height=25,%
        width=1,%
        depth=25,%
}};

\pic[shift={(0,0,0)}] at (upsample3-east) {DoubleRightBandedBox={%
        name=upconv3,%
        xlabel={{"C3", ""}},%
        zlabelmiddle=false,
        sticky=false,
        fill=\ConvColor,%
        bandonefill=\ConvReluColor,%
        bandtwofill=\BatchNormColor,%
        height=25,%
        width={5},%
        depth=25%
}};

\pic[shift={(0,0,0)}] at (upconv3-east) {Box={
        name=fusion3,%
        fill=\FusionColor,
        opacity=0.6,
        height=25,%
        width=5,%
        depth=25,%
        xlabel={{"C3", ""}},
        zlabel={I/4},%
        zlabelmiddle=false,
}};


%%%%%%%%%%%%%%


\pic[shift={(1.5,0,0)}] at (fusion3-east) {Box={
        name=upsample2,%
        fill=\UpsampleColor,
        opacity=0.6,
        height=32,%
        width=1,%
        depth=32,%
}};

\pic[shift={(0,0,0)}] at (upsample2-east) {DoubleRightBandedBox={%
        name=upconv2,%
        xlabel={{"C2", ""}},%
        sticky=false,
        fill=\ConvColor,%
        bandonefill=\ConvReluColor,%
        bandtwofill=\BatchNormColor,%
        height=32,%
        width={4},%
        depth=32%
}};

\pic[shift={(0,0,0)}] at (upconv2-east) {Box={
        name=fusion2,%
        fill=\FusionColor,
        opacity=0.6,
        height=32,%
        width=4,%
        depth=32,%
        xlabel={{"C2", ""}},
        zlabel={I/2},%
        zlabelmiddle=false
}};



%%%%%%%%%%%%%%


\pic[shift={(1.5,0,0)}] at (fusion2-east) {Box={
        name=upsample1,%
        fill=\UpsampleColor,
        opacity=0.6,
        height=40,%
        width=1,%
        depth=40,%
}};

\pic[shift={(0,0,0)}] at (upsample1-east) {DoubleRightBandedBox={%
        name=upconv1,%
        xlabel={{"C1", ""}},%
        zlabelmiddle=false,
        sticky=false,
        fill=\ConvColor,%
        bandonefill=\ConvReluColor,%
        bandtwofill=\BatchNormColor,%
        height=40,%
        width={3},%
        depth=40%
}};

\pic[shift={(0,0,0)}] at (upconv1-east) {Box={
        name=fusion1,%
        fill=\FusionColor,
        opacity=0.6,
        height=40,%
        width=3,%
        depth=40,%
        xlabel={{"C1", ""}},
        zlabel=I,%
        zlabelmiddle=false,
}};


%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
%% Classifier 
%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%

\pic[shift={(1.5,0,0)}] at (fusion1-east) {Box={
        name=classifier,%
        fill=\ClassifierColor,
        opacity=0.6,
        height=40,%
        width=1,%
        depth=40,%
        xlabel={{"1", ""}},
        ylabel=W,
        zlabel=H,
        caption=Convolution 1D
}};


% \node[canvas is zy plane at x=3] (temp) at (classifier-east) {\includegraphics[width=8cm,height=8cm]{../6_A_mask.png}};


%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
% Draw connections
%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
\draw [connection]  (stem-east)  -- node {\midarrow} (cmunext-block1-west);
\draw [connection]  (conv1-east)  -- node {\midarrow} (cmunext-block2-west);
\draw [connection]  (conv2-east)  -- node {\midarrow} (cmunext-block3-west);
\draw [connection]  (conv3-east)  -- node {\midarrow} (cmunext-block4-west);
\draw [connection]  (conv4-east)  -- node {\midarrow} (cmunext-block5-west);
\draw [connection]  (conv5-east)  -- node {\midarrow} (upsample4-west);
\draw [connection]  (fusion4-east)  -- node {\midarrow} (upsample3-west);
\draw [connection]  (fusion3-east)  -- node {\midarrow} (upsample2-west);
\draw [connection]  (fusion2-east)  -- node {\midarrow} (upsample1-west);
\draw [connection]  (fusion1-east)  -- node {\midarrow} (classifier-west);

\path (conv1-southeast) -- (conv1-northeast) coordinate[pos=1.25] (conv1-top) ;
\path (conv2-southeast) -- (conv2-northeast) coordinate[pos=1.25] (conv2-top) ;
\path (conv3-southeast) -- (conv3-northeast) coordinate[pos=1.25] (conv3-top) ;
\path (conv4-southeast) -- (conv4-northeast) coordinate[pos=1.25] (conv4-top) ;

\path (fusion4-south)  -- (fusion4-north)  coordinate[pos=1.25] (fusion4-top) ;
\path (fusion3-south)  -- (fusion3-north)  coordinate[pos=1.25] (fusion3-top) ;
\path (fusion2-south)  -- (fusion2-north)  coordinate[pos=1.25] (fusion2-top) ;
\path (fusion1-south)  -- (fusion1-north)  coordinate[pos=1.25] (fusion1-top) ;
%
\draw [copyconnection]  (conv1-northeast)  
-- node {\copymidarrow}(conv1-top)
-- node {\copymidarrow}(fusion1-top)
-- node {\copymidarrow} (fusion1-north);

\draw [copyconnection]  (conv2-northeast)  
-- node {\copymidarrow}(conv2-top)
-- node {\copymidarrow}(fusion2-top)
-- node {\copymidarrow} (fusion2-north);

\draw [copyconnection]  (conv3-northeast)  
-- node {\copymidarrow}(conv3-top)
-- node {\copymidarrow}(fusion3-top)
-- node {\copymidarrow} (fusion3-north);

\draw [copyconnection]  (conv4-northeast)  
-- node {\copymidarrow}(conv4-top)
-- node {\copymidarrow}(fusion4-top)
-- node {\copymidarrow} (fusion4-north);

%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%

% Find the center point of the entire diagram
\path (stem-west) -- (classifier-east) coordinate[pos=0.5] (diagram-center);

\newcommand{\legendentry}[2]{%
  \raisebox{-0.2em}{\textcolor{#1}{\rule{0.4cm}{0.4cm}}}~%
  \raisebox{0.1em}{\parbox[t]{2.5cm}{#2}}%
  \vspace{0.1cm}
}


\newcommand{\legendarrow}[2]{%
  \raisebox{-0.10em}{#1}~%
  \raisebox{0.1em}{\parbox[t]{3cm}{\textcolor{\SkipConnectionColor}#2}}%
}


% Adaptive caption box below the diagram
\node[
    draw=black, thick, fill=white, text width=9cm, align=left,
    below=5cm of diagram-center, anchor=north
] (caption-box) {
    \begin{minipage}{\linewidth}
    \vspace{0.1cm}  % Top padding
    \begin{tabularx}{\linewidth}{@{}X X X@{}}
        \legendentry{\ConvColor}{Convolution +\\ BN + ReLU} &
        \legendentry{\MaxpoolColor}{Max Pooling} &
        \legendentry{\UpsampleColor}{Bilinear Upsampling} \\[0.2cm]
        
        \legendentry{\FusionColor}{Skip Fusion} &
        \legendentry{\ClassifierColor}{Classifier} &
         \legendentry{\CmunextBlockColor}{Mobile-CMUNeXt \\Block} \\[0.2cm]
        \multicolumn{3}{c}{
            \legendarrow{\copymidarrow}{Skip Connection}
        }
    \end{tabularx}

    \vspace{0.1cm}  % Bottom padding
    \end{minipage}
};


\end{tikzpicture}
\end{document}
