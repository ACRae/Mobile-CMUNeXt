\documentclass[border=8pt, multi, tikz]{standalone}
%\usepackage{blocks}
\usepackage{import}
\subimport{../../../layers}{init}
\usetikzlibrary{positioning}
\usetikzlibrary{3d}

\def\ConvColor{rgb:yellow,5;red,2.5;white,5}
\def\BatchNormColor{rgb:yellow,5;red,5;white,5}
\def\ReluColor{rgb:blue,2;green,1;black,0.3}
\def\PoolColor{rgb:red,1;black,0.3}
\def\UnpoolColor{rgb:blue,2;green,1;black,0.3}
\def\FcColor{rgb:blue,5;red,2.5;white,5}
\def\FcReluColor{rgb:blue,5;red,5;white,4}
\def\SoftmaxColor{rgb:magenta,5;black,7}
\def\ConcatColor{rgb:blue,5;red,2.5;white,5}

\def\FusionColor{rgb:blue,5;red,4;white,5}
\def\SkipConnectionColor{rgb:blue,4;red,1;green,1;black,3}

\newcommand{\copymidarrow}{\tikz \draw[-Stealth,line width =0.8mm,draw={rgb:blue,4;red,1;green,1;black,3}] (-0.3,0) -- ++(0.3,0);}

\begin{document}
\begin{tikzpicture}
\clip (-4.0,-6) rectangle (15,4.5); % ADJUST VIEW HERE!!!
\tikzstyle{connection}=[ultra thick, every node/.style={sloped,allow upside down}, draw=\edgecolor, opacity=0.7]
\tikzstyle{copyconnection}=[ultra thick,every node/.style={sloped,allow upside down},draw={rgb:blue,4;red,1;green,1;black,3},opacity=0.7]

%%%
% MOBILE-CMUNEXT-BLOCK
%%%
% \pic[shift={(0,0,0)}] at (0,0,0) {Box={
%         name=input,%
%         fill=\BatchNormColor,
%         opacity=0.6,
%         height=15,
%         width=1,
%         depth=15,
%         caption=Input,
%         xlabel={"C"},
%         ylabel=W,
%         zlabel=H
% }};

\pic at (0.5,0,0) {Ball={
        name=add,
        fill=\ConcatColor,
        radius=2,
        logo=$+$
}};

\pic[shift={(2,0,0)}] at (add-east) {DoubleRightBandedBox={%
    name=conv1,%
    xlabel={{"C"}},%
    %zlabel=I,%
    sticky=false,
    fill=\ConvColor,%
    bandonefill=\BatchNormColor,%
    bandtwofill=\ReluColor,%
    height=15,%
    width={3},%
    depth=15,%
    caption=Channelwise
}};

\pic[shift={(2,0,0)}] at (conv1-east) {DoubleRightBandedBox={%
    name=pw-conv1,%
    xlabel={{"$C \times 4$", ""}},%
    %zlabel=I,%
    sticky=false,
    fill=\ConvColor,%
    bandonefill=\BatchNormColor,%
    bandtwofill=\ReluColor,%
    height=15,%
    width={12},%
    depth=15,%
    caption=Pointwise
}};


\pic[shift={(2,0,0)}] at (pw-conv1-east) {DoubleRightBandedBox={%
    name=pw-conv2,%
    xlabel={{"C"}},%
    %zlabel=I,%
    sticky=false,
    fill=\ConvColor,%
    bandonefill=\BatchNormColor,%
    bandtwofill=\ReluColor,%
    height=15,%
    width={3},%
    depth=15,%
    caption=Pointwise
}};


\pic[shift={(0,0,0)}] at (0,0,0) {Box={name=block,caption=,%
        xlabel={{"",""}},fill=\FusionColor,opacity=0.1,height=25,width={60},depth=25}};


\draw [copyconnection] (-3,4,0) -- node {\copymidarrow} (0.5,4,0) -- node {\copymidarrow} (add-north); % SKIP CONNECTION
\draw [connection] (-3,0,0) -- node {\midarrow} (add-west); % INPUT
\draw [connection] (add-east) -- node {\midarrow} (conv1-west);
\draw [connection]  (conv1-east)  -- node {\midarrow} (pw-conv1-west);
\draw [connection]  (pw-conv1-east)  -- node {\midarrow} (pw-conv2-west);
\path (pw-conv2-west) -- (pw-conv2-east)   coordinate[pos=4] (output) ;
\draw [connection]  (pw-conv2-west) -- node {\midarrow} (output);


%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%

% Find the center point of the entire diagram
\path (add-west) -- (pw-conv2-east) coordinate[pos=0.5] (diagram-center);

\newcommand{\legendentry}[2]{%
  \raisebox{-0.2em}{\textcolor{#1}{\rule{0.4cm}{0.4cm}}}~%
  \raisebox{0.1em}{\parbox[t]{2.5cm}{#2}}%
  \vspace{0.1cm}
}

\newcommand{\legendarrow}[2]{%
  \raisebox{-0.10em}{#1}~%
  \raisebox{0.1em}{\parbox[t]{3cm}{\textcolor{\SkipConnectionColor}#2}}%
}



% Adaptive caption box below the diagram
\node[
    draw=black, thick, fill=white, text width=7.5cm, align=center,
    below=4.5cm of diagram-center, anchor=north
] (caption-box) {
    \begin{minipage}{\linewidth}
    \vspace{0.1cm}  % Top padding
    \begin{tabularx}{\linewidth}{@{}X X X@{}}
        \legendentry{\ConvColor}{Convolution} &
        \legendentry{\BatchNormColor}{BatchNorm} &
        \legendentry{\ReluColor}{ReLU} \\
        \multicolumn{3}{c}{
            \legendarrow{\copymidarrow}{Skip Connection}
        }
    \end{tabularx}
    \end{minipage}
};



\end{tikzpicture}
\end{document}
