\documentclass[border=8pt, multi, tikz]{standalone}
%\usepackage{blocks}
\usepackage{import}
\subimport{../../../layers}{init}
\usetikzlibrary{positioning}
\usetikzlibrary{3d}

\def\ConvColor{rgb:yellow,5;red,2.5;white,5}
\def\BnColor{rgb:yellow,5;red,5;white,5}
\def\ReluColor{rgb:blue,2;green,1;black,0.3}
\def\ConcatColor{rgb:blue,5;red,2.5;white,5}
\def\CmunextBlockColor{rgb:blue,5;white,3}

\newcommand{\copymidarrow}{\tikz \draw[-Stealth,line width =0.8mm,draw={rgb:blue,4;red,1;green,1;black,3}] (-0.3,0) -- ++(0.3,0);}

\begin{document}
\begin{tikzpicture}
\clip (-3.0,-8) rectangle (21,6); % ADJUST VIEW HERE!!!
\tikzstyle{connection}=[ultra thick, every node/.style={sloped,allow upside down}, draw=\edgecolor, opacity=0.7]
\tikzstyle{copyconnection}=[ultra thick,every node/.style={sloped,allow upside down},draw={rgb:blue,4;red,1;green,1;black,3},opacity=0.7]

%%%
% MOBILE-CMUNEXT-BLOCK
%%%

\pic[shift={(1,0,0)}] at (0,0,0) {DoubleRightBandedBox={%
    name=dp-conv1,%
    xlabel={{"C"}},%
    %zlabel=I,%
    sticky=false,
    fill=\ConvColor,%
    bandonefill=\BnColor,%
    bandtwofill=\ReluColor,%
    height=15,%
    width={3},%
    depth=15,%
    caption=Depthwise
}};

\pic[shift={(1.5,0,0)}] at (dp-conv1-east) {Ball={
    name=add1,fill=\ConcatColor,radius=2,logo=$+$}};

\pic[shift={(2,0,0)}] at (add1-east) {DoubleRightBandedBox={%
    name=dp-conv2,%
    xlabel={{"C"}},%
    %zlabel=I,%
    sticky=false,
    fill=\ConvColor,%
    bandonefill=\BnColor,%
    bandtwofill=\ReluColor,%
    height=15,%
    width={3},%
    depth=15,%
    caption=Depthwise
}};

\pic[shift={(1.5,0,0)}] at (dp-conv2-east) {Ball={
        name=add2,
        fill=\ConcatColor,
        radius=2,
        logo=$+$
}};


\pic[shift={(1,0,0)}] at (add2-east) {DoubleRightBandedBox={%
    name=pw-conv1,%
    xlabel={{"$C \times 4$", ""}},%
    %zlabel=I,%
    sticky=false,
    fill=\ConvColor,%
    bandonefill=\BnColor,%
    bandtwofill=\ReluColor,%
    height=15,%
    width={12},%
    depth=15,%
    caption=Pointwise
}};


\pic[shift={(2,0,0)}] at (pw-conv1-east) {DoubleRightBandedBox={%
    name=pw-conv2,%
    xlabel={{"C"}},%
    %zlabel=I,%
    sticky=false,
    fill=\ConvColor,%
    bandonefill=\BnColor,%
    bandtwofill=\ReluColor,%
    height=15,%
    width={3},%
    depth=15,%
    caption=Pointwise
}};

\pic[shift={(0,0,0)}] at (0,0,0) {Box={name=block,caption=Block with variable depth,%
        xlabel={{"",""}},fill=,opacity=0.1,height=35,width={75},depth=35}};


\pic[shift={(2.5,0,0)}] at (block-east) {DoubleRightBandedBox={%
    name=cw-conv,%
    xlabel={{"C"}},%
    %zlabel=I,%
    sticky=false,
    fill=\ConvColor,%
    bandonefill=\BnColor,%
    bandtwofill=\ReluColor,%
    height=15,%
    width={3},%
    depth=15,%
    caption=Channelwise
}};



% Residual connections
\draw [connection] (-2,0,0) -- node {\midarrow} (dp-conv1-west); % INPUT
\draw [copyconnection] (-0,0,0) -- node {\copymidarrow} (0,2.8,0); % UP
\draw [copyconnection] (0,2.8,0) -- node {\copymidarrow} (3.1,2.8,0); % RIGHT
\node at (1.5,3.2,0) {Residual};
\draw [copyconnection] (3.1,2.8,0) -- node {\copymidarrow} (3.1,0.4,0); % DOWN

\draw [copyconnection] (4.5,0,0) -- node {\copymidarrow} (4.5,2.8,0); % UP
\draw [copyconnection] (4.5,2.8,0) -- node {\copymidarrow} (7.6,2.8,0); % RIGHT
\node at (6,3.2,0) {Residual};
\draw [copyconnection] (7.6,2.8,0) -- node {\copymidarrow} (7.6,0.4,0); % DOWN


% \draw [connection]  (input-east)  -- node {\midarrow} (dp-conv1-west);
\draw [connection]  (dp-conv1-east)  -- node {\midarrow} (add1-west);
\draw [connection]  (add1-east)  -- node {\midarrow} (dp-conv2-west);
\draw [connection]  (dp-conv2-east)  -- node {\midarrow} (add2-west);
\draw [connection]  (add2-east)  -- node {\midarrow} (pw-conv1-west);
\draw [connection]  (pw-conv1-east)  -- node {\midarrow} (pw-conv2-west);
\draw [connection]  (pw-conv2-east) -- (block-east);
\draw [connection]  (block-east)  -- node {\midarrow} (cw-conv-west);


\path (cw-conv-west) -- (cw-conv-east)   coordinate[pos=4] (output) ;
\draw [connection]  (cw-conv-west) -- node {\midarrow} (output);


%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%

% Find the center point of the entire diagram
\path (dp-conv1-west) -- (cw-conv-east) coordinate[pos=0.5] (diagram-center);

\newcommand{\legendentry}[2]{%
  \raisebox{-0.2em}{\textcolor{#1}{\rule{0.4cm}{0.4cm}}}~%
  \raisebox{0.1em}{\parbox[t]{2.5cm}{#2}}%
  \vspace{0.1cm}
}


% Adaptive caption box below the diagram
\node[
    draw=black, thick, fill=white, text width=7.5cm, align=left,
    below=7cm of diagram-center, anchor=north
] (caption-box) {
    \begin{minipage}{\linewidth}
    \vspace{0.1cm}  % Top padding
    \begin{tabularx}{\linewidth}{@{}X X X@{}}
       \legendentry{\ConvColor}{Convolution} &
       \legendentry{\BnColor}{BatchNorm} &
       \legendentry{\ReluColor}{Hardswish} \\
    \end{tabularx}
    \end{minipage}
};


\end{tikzpicture}
\end{document}
