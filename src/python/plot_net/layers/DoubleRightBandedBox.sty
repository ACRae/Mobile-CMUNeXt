\ProvidesPackage{DoubleRightBandedBox}
\RequirePackage{tikz}

\newif\ifDRBBsticky % The global sticky flag
\newif\ifDRBBzlabelmiddle
\newcounter{DRBBtotalSegments} % To store the total number of segments in the \cubex list

\tikzset{
    DoubleRightBandedBox/.pic={
        \tikzset{/block/.cd,#1} % Apply options passed to the .pic

        % --- Calculate total number of segments based on the 'width' key ---
        \setcounter{DRBBtotalSegments}{0}
        % \cubex (from width key) can be a single number or a list like {2,3,4}
        \foreach \tmpitem in \cubex { \stepcounter{DRBBtotalSegments} }
        % ---

        % Styles for box and bands
        \tikzstyle{box}=[every edge/.append style={pic actions, densely dashed, opacity=.7},fill opacity=\opacity, pic actions,fill=\fill]
        \tikzstyle{band1}=[every edge/.append style={pic actions, densely dashed, opacity=.7},fill opacity=\bandoneopacity, pic actions,fill=\bandonefill,draw=\bandonefill]
        \tikzstyle{band2}=[every edge/.append style={pic actions, densely dashed, opacity=.7},fill opacity=\bandtwoopacity, pic actions,fill=\bandtwofill,draw=\bandtwofill]

        \pgfmathsetmacro{\y}{\cubey*\scale}
        \pgfmathsetmacro{\z}{\cubez*\scale}

        % Multiple concatenated boxes
        \foreach[count=\i,% \i is the 1-based index of the current segment
            evaluate=\i as \xlabel using {array({\boxlabels},\i-1)},%
            evaluate=\unscaledx as \k using {\unscaledx*\scale+\prev}, remember=\k as \prev (initially 0)]
            \unscaledx in \cubex
        {
            \pgfmathsetmacro{\x}{\unscaledx*\scale}
            % Coordinates for the current box segment
            \coordinate (a)    at (\k-\x   , \y/2 , \z/2);
            \coordinate (art1) at (\k-\x/2 , \y/2 , \z/2); % a_right_half (for band1)
            \coordinate (art2) at (\k-\x/4 , \y/2 , \z/2); % a_right_quarter (for band2)
            \coordinate (b)    at (\k-\x   ,-\y/2 , \z/2);
            \coordinate (brt1) at (\k-\x/2 ,-\y/2 , \z/2); % b_right_half (for band1)
            \coordinate (brt2) at (\k-\x/4 ,-\y/2 , \z/2); % b_right_quarter (for band2)
            \coordinate (c)    at (\k      ,-\y/2 , \z/2);
            \coordinate (d)    at (\k      , \y/2 , \z/2);
            \coordinate (e)    at (\k      , \y/2 ,-\z/2);
            \coordinate (f)    at (\k      ,-\y/2 ,-\z/2);
            \coordinate (g)    at (\k-\x   ,-\y/2 ,-\z/2);
            \coordinate (h)    at (\k-\x   , \y/2 ,-\z/2);
            \coordinate (hrt1) at (\k-\x/2 , \y/2 ,-\z/2); % h_right_half (for band1)
            \coordinate (hrt2) at (\k-\x/4 , \y/2 ,-\z/2); % h_right_quarter (for band2)

            % Fill base box color
            \draw [box]
                (d) -- (a) -- (b) -- (c) -- cycle  % Near face
                (d) -- (a) -- (h) -- (e) -- cycle; % Top face
            % Dotted edges for hidden parts
            \draw [box]
                (f) edge (g)
                (b) edge (g)
                (h) edge (g);

            % --- Define a command to draw the bands for the current segment ---
            % This is defined inside the loop to have access to current coordinates (a,d,art1, etc.)
            \def\DrawTheBandsForCurrentSegment{
                % Fill first band color (middle band)
                \draw [band1]
                    (d) -- (art1) -- (brt1) -- (c) -- cycle  % Band on near face
                    (d) -- (art1) -- (hrt1) -- (e) -- cycle; % Band on top face
                % Fill second band color (rightmost band)
                \draw [band2]
                    (d) -- (art2) -- (brt2) -- (c) -- cycle  % Band on near face
                    (d) -- (art2) -- (hrt2) -- (e) -- cycle; % Band on top face
                % Redraw edges that were covered by bands to ensure they are visible
                \draw [box,fill opacity=0]
                    (d) -- (a) -- (b) -- (c) -- cycle
                    (d) -- (a) -- (h) -- (e) -- cycle;
            }
            % --- End of definition ---

            % --- Conditionally execute the band drawing ---
            \ifDRBBsticky % If global sticky is true, draw bands for every segment
                \DrawTheBandsForCurrentSegment
            \else          % If global sticky is false...
                \ifnum\i=\value{DRBBtotalSegments}\relax % ...only draw bands for the LAST segment
                    \DrawTheBandsForCurrentSegment
                \fi
            \fi
            % --- End of conditional drawing ---

            % Place the x-label for the current box
            \path (b) edge ["\xlabel"',midway] (c);

            \xdef\LastEastx{\k} % Store the x-coordinate of the eastern face of the last box drawn
        }%Loop ends

        % Draw the east face of the very last box segment (c,d,e,f are from the last iteration)
        % This applies to the east face of the (potentially) banded last segment.
        \draw [box] (d) -- (e) -- (f) -- (c) -- cycle;   % East face filled with base box color
        \draw [band1] (d) -- (e) -- (f) -- (c) -- cycle; % East face overlaid with band1 color/style
        \draw [band2] (d) -- (e) -- (f) -- (c) -- cycle; % East face overlaid with band2 color/style (this will be the final apparent fill)
        \draw [pic actions] (d) -- (e) -- (f) -- (c) -- cycle; % Redraw East face edges with overall pic style

        % Labels and caption
        \coordinate (a1) at (0 , \y/2 , \z/2);
        \coordinate (b1) at (0 ,-\y/2 , \z/2);
        \tikzstyle{depthlabel}=[pos=0,text width=14*\z,text centered,sloped]
        
        \ifDRBBzlabelmiddle
            \path (c) edge ["\small\zlabels"',midway](f); % Midway label
        \else
            \path (c) edge ["\small\zlabels"',depthlabel](f); % Depth label
        \fi
        
        \path (b1) edge ["\ylabel",midway] (a1);  % Height label

        \tikzstyle{captionlabel}=[text width=15*\LastEastx/\scale,text centered]
        \path (\LastEastx/2,-\y/2,+\z/2) + (0,-25pt) coordinate (cap)
        edge ["\textcolor{black}{ \bf \caption}"',captionlabel] (cap); % Block caption

        % Define anchor nodes for the pic object
        \coordinate (\name-west)  at (0,0,0) ;
        \coordinate (\name-east)  at (\LastEastx, 0,0) ;
        \coordinate (\name-north) at (\LastEastx/2,\y/2,0);
        \coordinate (\name-south) at (\LastEastx/2,-\y/2,0);
        \coordinate (\name-anchor) at (\LastEastx/2, 0,0) ;

        \coordinate (\name-near) at (\LastEastx/2,0,\z/2);
        \coordinate (\name-far)  at (\LastEastx/2,0,-\z/2);

        \coordinate (\name-nearwest) at (0,0,\z/2);
        \coordinate (\name-neareast) at (\LastEastx,0,\z/2);
        \coordinate (\name-farwest)  at (0,0,-\z/2);
        \coordinate (\name-fareast)  at (\LastEastx,0,-\z/2);

        \coordinate (\name-northeast) at (\name-north-|\name-east);
        \coordinate (\name-northwest) at (\name-north-|\name-west);
        \coordinate (\name-southeast) at (\name-south-|\name-east);
        \coordinate (\name-southwest) at (\name-south-|\name-west);

        \coordinate (\name-nearnortheast)  at (\LastEastx, \y/2, \z/2); % d (from last segment)
        \coordinate (\name-farnortheast)   at (\LastEastx, \y/2,-\z/2); % e (from last segment)
        \coordinate (\name-nearsoutheast)  at (\LastEastx,-\y/2, \z/2); % c (from last segment)
        \coordinate (\name-farsoutheast)   at (\LastEastx,-\y/2,-\z/2); % f (from last segment)

        \coordinate (\name-nearnorthwest)  at (0, \y/2, \z/2);
        \coordinate (\name-farnorthwest)   at (0, \y/2,-\z/2);
        \coordinate (\name-nearsouthwest)  at (0,-\y/2, \z/2);
        \coordinate (\name-farsouthwest)   at (0,-\y/2,-\z/2);
    },
    /block/.search also={/tikz}, % Allow TikZ options to be used directly within /block scope
    /block/.cd,
    sticky/.is if=DRBBsticky, % User-facing key: sticky=true or sticky=false
    sticky=true,              % Default behavior: bands are repeated for each box
    zlabelmiddle/.is if=DRBBzlabelmiddle,
    zlabelmiddle=true,
    width/.store   in=\cubex,
    height/.store  in=\cubey,
    depth/.store   in=\cubez,
    scale/.store   in=\scale,
    xlabel/.store  in=\boxlabels,
    ylabel/.store  in=\ylabel,
    zlabel/.store  in=\zlabels,
    caption/.store in=\caption,
    name/.store    in=\name,
    fill/.store    in=\fill,
    bandonefill/.store in=\bandonefill,
    bandtwofill/.store in=\bandtwofill,
    opacity/.store in=\opacity,
    bandoneopacity/.store in=\bandoneopacity,
    bandtwoopacity/.store in=\bandtwoopacity,
    fill={rgb:red,5;green,5;blue,5;white,15},
    bandonefill={rgb:red,15;green,5;blue,5;white,5},
    bandtwofill={rgb:red,5;green,15;blue,5;white,5},
    opacity=0.4,
    bandoneopacity=0.6,
    bandtwoopacity=0.7,
    width=2, % Can be a single value or a list e.g. {2} or {2,3,1}
    height=13,
    depth=15,
    scale=.2,
    xlabel={{"","","","","","","","","",""}},
    ylabel=,
    zlabel=,
    caption=,
    name=drbbnode, % Default name for the pic's coordinates
}